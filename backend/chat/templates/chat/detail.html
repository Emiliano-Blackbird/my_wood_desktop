{% extends "general/layout.html" %}
{% block title %}Chat — {% for p in conversation.participants.all %}{% if p != request.user %}{{ p.get_full_name|default:p.username }}{% endif %}{% endfor %}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="fw-semibold">
        {% for p in conversation.participants.all %}
          {% if p != request.user %}{{ p.get_full_name|default:p.username }}{% endif %}
        {% endfor %}
      </div>
      <small class="text-muted">{{ conversation.updated_at|timesince }} atrás</small>
    </div>

    <div class="card-body" id="messagesContainer" style="max-height:60vh; overflow:auto;">
      {% for message in messages %}
        {% include 'chat/_message_item.html' with message=message %}
      {% empty %}
        <p class="text-muted">No hay mensajes aún.</p>
      {% endfor %}
    </div>

    <div class="card-footer">
      <form method="post" action="">
        {% csrf_token %}
        <div class="input-group">
          <textarea name="body" class="form-control" rows="1" placeholder="Escribe un mensaje..." required></textarea>
          <button class="btn btn-primary" type="submit">Enviar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // auto-scroll al final
  (function () {
    const mc = document.getElementById('messagesContainer');
    if (mc) { mc.scrollTop = mc.scrollHeight; }
  })();
</script>
{% endblock %}